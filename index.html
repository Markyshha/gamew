<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шарики</title>
    <style>
        body {
            margin: 0;
            padding: 5px;
            background: #f0f0f0;
            font-family: Arial;
        }
        .game-container {
            width: 220px;
            margin: 0 auto;
            background: white;
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 0 3px rgba(0,0,0,0.2);
        }
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .game-board {
            width: 220px;
            height: 352px;
            background: #ddd;
            position: relative;
            overflow: hidden;
        }
        .ball {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.2s;
        }
        .ball.selected {
            box-shadow: 0 0 5px gold;
        }
        button {
            margin-top: 5px;
            padding: 3px 8px;
            font-size: 11px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div>Шарики</div>
            <div>Очки: <span id="score">0</span></div>
        </div>
        <div class="game-board" id="gameBoard"></div>
        <button id="newGameBtn">Новая игра</button>
    </div>

    <script>
        const colors = ['red', 'blue', 'green', 'yellow', 'purple'];
        const boardSize = { rows: 8, cols: 5 };
        const ballSize = 40;
        const spacing = 44;
        let board = [];
        let selected = null;
        let score = 0;
        let animating = false;

        function init() {
            score = 0;
            document.getElementById('score').textContent = score;
            createBoard();
            render();
        }

        function createBoard() {
            board = [];
            for (let r = 0; r < boardSize.rows; r++) {
                board[r] = [];
                for (let c = 0; c < boardSize.cols; c++) {
                    board[r][c] = {
                        color: colors[Math.floor(Math.random() * colors.length)],
                        id: `ball-${r}-${c}`
                    };
                }
            }
        }

        function render() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            
            for (let r = 0; r < boardSize.rows; r++) {
                for (let c = 0; c < boardSize.cols; c++) {
                    if (!board[r][c]) continue;
                    
                    const ball = document.createElement('div');
                    ball.className = 'ball';
                    ball.id = board[r][c].id;
                    ball.style.background = board[r][c].color;
                    ball.style.left = (c * spacing) + 'px';
                    ball.style.top = (r * spacing) + 'px';
                    
                    ball.addEventListener('click', () => handleClick(r, c));
                    gameBoard.appendChild(ball);
                }
            }
        }

        function handleClick(r, c) {
            if (animating) return;
            
            const ball = document.getElementById(board[r][c].id);
            if (!ball) return;

            if (!selected) {
                selected = { r, c };
                ball.classList.add('selected');
            } else {
                const first = selected;
                const second = { r, c };

                if (isAdjacent(first, second)) {
                    animating = true;
                    document.getElementById(board[first.r][first.c].id).classList.remove('selected');
                    
                    swapBalls(first, second, () => {
                        [board[first.r][first.c], board[second.r][second.c]] = 
                        [board[second.r][second.c], board[first.r][first.c]];
                        
                        board[first.r][first.c].id = `ball-${first.r}-${first.c}`;
                        board[second.r][second.c].id = `ball-${second.r}-${second.c}`;

                        const matches = findMatches();
                        if (matches.length) processMatches(matches);
                        else { animating = false; render(); }
                    });
                } else {
                    document.getElementById(board[first.r][first.c].id).classList.remove('selected');
                }
                selected = null;
            }
        }

        function swapBalls(b1, b2, callback) {
            const el1 = document.getElementById(board[b1.r][b1.c].id);
            const el2 = document.getElementById(board[b2.r][b2.c].id);
            
            el1.style.left = (b2.c * spacing) + 'px';
            el1.style.top = (b2.r * spacing) + 'px';
            el2.style.left = (b1.c * spacing) + 'px';
            el2.style.top = (b1.r * spacing) + 'px';

            setTimeout(callback, 200);
        }

        function isAdjacent(b1, b2) {
            return (Math.abs(b1.r - b2.r) === 1 && b1.c === b2.c) || 
                   (Math.abs(b1.c - b2.c) === 1 && b1.r === b2.r);
        }

        function findMatches() {
            const matches = [];
            const matched = {};

            // Проверка по вертикали
            for (let c = 0; c < boardSize.cols; c++) {
                let color = board[0][c].color;
                let count = 1;

                for (let r = 1; r < boardSize.rows; r++) {
                    if (board[r][c] && board[r][c].color === color) {
                        count++;
                    } else {
                        if (count >= 4) addMatches(r - count, r - 1, c, true);
                        if (board[r][c]) color = board[r][c].color;
                        count = 1;
                    }
                }
                if (count >= 4) addMatches(boardSize.rows - count, boardSize.rows - 1, c, true);
            }

            // Проверка по горизонтали
            for (let r = 0; r < boardSize.rows; r++) {
                let color = board[r][0].color;
                let count = 1;

                for (let c = 1; c < boardSize.cols; c++) {
                    if (board[r][c] && board[r][c].color === color) {
                        count++;
                    } else {
                        if (count >= 4) addMatches(r, r, c - count, c - 1, false);
                        if (board[r][c]) color = board[r][c].color;
                        count = 1;
                    }
                }
                if (count >= 4) addMatches(r, r, boardSize.cols - count, boardSize.cols - 1, false);
            }

            function addMatches(r1, r2, c1, c2, vertical) {
                if (vertical) {
                    for (let r = r1; r <= r2; r++) {
                        const key = `${r},${c1}`;
                        if (!matched[key]) {
                            matches.push({r, c: c1});
                            matched[key] = true;
                        }
                    }
                } else {
                    for (let c = c1; c <= c2; c++) {
                        const key = `${r1},${c}`;
                        if (!matched[key]) {
                            matches.push({r: r1, c});
                            matched[key] = true;
                        }
                    }
                }
            }

            return matches;
        }

        function processMatches(matches) {
            score += matches.length * 10;
            document.getElementById('score').textContent = score;

            matches.forEach(m => {
                const el = document.getElementById(board[m.r][m.c].id);
                if (el) el.style.display = 'none';
            });

            setTimeout(() => {
                matches.forEach(m => board[m.r][m.c] = null);
                
                for (let c = 0; c < boardSize.cols; c++) {
                    let empty = boardSize.rows - 1;
                    for (let r = boardSize.rows - 1; r >= 0; r--) {
                        if (board[r][c]) {
                            board[empty][c] = board[r][c];
                            board[empty][c].id = `ball-${empty}-${c}`;
                            if (empty !== r) board[r][c] = null;
                            empty--;
                        }
                    }
                    for (let r = empty; r >= 0; r--) {
                        board[r][c] = {
                            color: colors[Math.floor(Math.random() * colors.length)],
                            id: `ball-${r}-${c}`
                        };
                    }
                }

                render();
                
                setTimeout(() => {
                    const newMatches = findMatches();
                    if (newMatches.length) processMatches(newMatches);
                    else animating = false;
                }, 400);
            }, 200);
        }

        document.getElementById('newGameBtn').addEventListener('click', init);
        init();
    </script>
</body>
</html>